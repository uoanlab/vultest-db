# reference
# https://nvd.nist.gov/vuln/detail/CVE-2015-3224

cve: CVE-2015-3224
attack_vector: remote

construction:
  os:
    name: ubuntu
    version: 16.04.1

  user:
    - name: rails
      shell: /bin/bash

  softwares:
    - name: libfuse-dev
    - name: libreadline-dev
    - name: libssl-dev
    - name: libsqlite3-dev
    - name: g++
    - name: sqlite3

    - name: nodejs
      version: 12.7.0
      method: nodenv
      user: rails
      user_dir: /home/rails

    - name: rails
      vulnerability: yes
      version: 4.1.1
      method: gem
      user: rails
      executable: /home/rails/.rbenv/shims/gem
      config:
        post_config:
          - name: rails_new
            command: "/home/rails/.rbenv/shims/rails new server"
            user: rails
            dir: /home/rails
          - name: setting_rails1
            file_add:
              path: /home/rails/server/config/environments/development.rb
              insertafter: "# config.action_view.raise_on_missing_translations = true"
              content: "  config.web_console.whitelisted_ips = %w(0.0.0.0/0)"
          - name: setting_rails2
            file_add:
              path: /home/rails/server/Gemfile
              content: "gem 'web-console', '2.1.2'"
          - name: setting_rails3
            file_replace:
              path: /home/rails/server/Gemfile
              regexp: "gem 'spring'"
              replace: "gem 'spring', '1.7.0'"
          - name: setting_rails4
            file_add:
              path: /home/rails/server/Gemfile
              content: "gem 'therubyracer', platforms: :ruby"
          - name: setting_rails5
            file_replace:
              path: /home/rails/server/Gemfile
              regexp: "gem 'sqlite3'"
              replace: "gem 'sqlite3', '1.3.9'"
          - name: setting_rails6
            file_delete:
              path: /home/rails/server/Gemfile.lock

          - name: bundler
            command: "/home/rails/.rbenv/shims/bundle install"
            user: rails
            dir: /home/rails/server

          - name: rails_server
            command: "/home/rails/.rbenv/shims/rails server -d -b 192.168.177.177"
            user: rails
            dir: /home/rails/server

      softwares:
        - name: ruby
          version: 2.3.3
          method: rbenv
          user: rails
          user_dir: /home/rails

        - name: bundler
          version: 1.16.2
          method: gem
          user: rails
          executable: /home/rails/.rbenv/shims/gem
