cve: CVE-2017-5487
attack_vector: remote

construction:
  os:
    name: ubuntu
    version: 18.04.1

  user:
    - name: mysql
      shell: /bin/bash

  softwares:
    - name: gcc

    - name: g++

    - name: libexpat1-dev

    - name: wordpress
      vulnerability: true
      version: 4.7.1
      method: source
      src_dir: /usr/local/src
      config:
        post_config:
          - name: create_wordpress
            db:
              database: wordpress
              login_user: root
              login_password: "K|6t|P.&GxAM"
              config_file: /etc/mysql/my.cnf
          - name: create_wordpress_user
            db_user:
              user: wordpressuser
              password: "ik42xa2Kt*DL"
              host: localhost
              priv: "*.*:ALL"
              login_user: root
              login_password: "K|6t|P.&GxAM"
              config_file: /etc/mysql/my.cnf

          - name: copy_wordpress
            file_copy:
              src: /usr/local/src/wordpress
              dest: /opt/httpd/htdocs
              owner: root
              group: root
              mode: "0755"
          - name: delete_original_wordpress
            file_delete:
              path: /usr/local/src/wordpress

          - name: copy_wp_config_sample
            file_copy:
              src: /opt/httpd/htdocs/wordpress/wp-config-sample.php
              dest: /opt/httpd/htdocs/wordpress/wp-config.php
              owner: root
              group: root
              mode: "0755"

          - name: replace_db_name_in_wordpress_config
            file_replace:
              path: /opt/httpd/htdocs/wordpress/wp-config.php
              regexp: "database_name_here"
              replace: "wordpress"
          - name: replace_username_in_wordpress_config
            file_replace:
              path: /opt/httpd/htdocs/wordpress/wp-config.php
              regexp: "username_here"
              replace: "wordpressuser"
          - name: replace_password_in_wordpress_config
            file_replace:
              path: /opt/httpd/htdocs/wordpress/wp-config.php
              regexp: "password_here"
              replace: "ik42xa2Kt*DL"
          - name: replace_host_in_wordpress_config
            file_replace:
              path: /opt/httpd/htdocs/wordpress/wp-config.php
              regexp: "localhost"
              replace: "127.0.0.1"

      softwares:
        - name: httpd
          version: 2.4.43
          method: source
          src_dir: /usr/local/src

          softwares:
            - name: perl
            - name: apr
              version: 1.7.0
              method: source
              src_dir: /usr/local/src
              config:
                pre_config:
                  configure: "./configure --prefix=/opt/apr"

            - name: apr-util
              version: 1.6.1
              method: source
              src_dir: /usr/local/src
              config:
                pre_config:
                  configure: "./configure --prefix=/opt/apr-util --with-apr=/opt/apr"

            - name: pcre
              version: 8.39
              method: source
              src_dir: /usr/local/src
              config:
                pre_config:
                  configure: "./configure --prefix=/opt/pcre"

          config:
            pre_config:
              configure: >-
                ./configure --enable-so
                --prefix=/opt/httpd
                --with-pcre=/opt/pcre
                --with-apr=/opt/apr
                --with-apr-util=/opt/apr-util

        - name: mysql-server
          config:
            post_config:
              - name: mysql
                service: mysql

        - name: mysql-client
          config:
            post_config:
              - name: change_admin_password_in_mysql
                db_user:
                  user: root
                  password: "K|6t|P.&GxAM"
                  host: localhost
                  priv: "*.*:ALL,GRANT"
                  login_user: root
                  login_password: root
                  config_file: /etc/mysql/my.cnf

        - name: libxml2-dev

        - name: libpng-dev

        - name: unzip

        - name: php
          version: 7.1.0
          method: source
          src_dir: /usr/local/src
          config:
            pre_config:
              configure: >-
                ./configure --enable-mbstring
                --with-gd
                --with-mysqli=mysqlnd
                --with-apxs2=/opt/httpd/bin/apxs
                --with-zlib
            post_config:
              - name: copy_php_ini
                file_copy:
                  src: /usr/local/src/php-7.1.0/php.ini-production
                  dest: /usr/local/lib/php.ini
                  owner: root
                  group: root
                  mode: "0755"
              - name: replace_http_conf
                file_replace:
                  path: /opt/httpd/conf/httpd.conf
                  regexp: "DirectoryIndex index.html"
                  replace: "DirectoryIndex index.html index.php"
              - name: add_x-http-php_in_http_conf
                file_add:
                  path: /opt/httpd/conf/httpd.conf
                  insertafter: "AddType application/x-gzip .*"
                  content: "    AddType application/x-httpd-php .php"
              - name: add_x-http-php-source_in_http_conf
                file_add:
                  path: /opt/httpd/conf/httpd.conf
                  insertafter: "AddType application/x-gzip .*"
                  content: "    AddType application/x-httpd-php-source .phps"
              - name: add_PHPIniDir_in_http.conf
                file_add:
                  path: /opt/httpd/conf/httpd.conf
                  content: "PHPIniDir /usr/local/lib/php.ini"
              - name: apachectl
                command: /opt/httpd/bin/apachectl start

    - name: wp-cli
      version: 0.24.1
      method: source
      src_dir: /usr/local/src
      config:
        post_config:
          - name: copy_wp
            file_copy:
              src: /usr/local/src/wp-cli-0.24.1.phar
              dest: /usr/local/bin/wp
              owner: root
              group: root
              mode: "0755"
          - name: wp_core_install
            command: >-
              wp core install --url=192.168.177.177/wordpress
              --path=/opt/httpd/htdocs/wordpress
              --title=vultest
              --admin_user=wpuser
              --admin_password="wppassword"
              --admin_email=m5231118@u-aizu.ac.jp
              --allow-root
