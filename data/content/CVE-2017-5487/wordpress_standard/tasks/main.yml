---
- name: Add DirectoryIndex index.html index.php in /opt/httpd/conf/httpd.conf
  replace:
    path: /opt/httpd/conf/httpd.conf
    regexp: "DirectoryIndex index.html"
    replace: "DirectoryIndex index.html index.php"

- name: Change /opt/httpd/conf/httpd.conf
  lineinfile:
    dest: /opt/httpd/conf/httpd.conf
    insertafter: "AddType application/x-gzip .*"
    line: "{{ item }}"
  with_items:
    - "    AddType application/x-httpd-php .php"
    - "    AddType application/x-httpd-php-source .phps"

- name: Search path of phpinfo
  shell: "php -r 'echo phpinfo();' | grep '(php.ini)' | sed 's/.* => //'"
  register: phpinfo_path
  environment:
    PATH: "/usr/local/bin:{{ ansible_env.PATH }}"

- name: Add PHPIniDir in /opt/httpd/conf/httpd.conf
  lineinfile:
    dest: /opt/httpd/conf/httpd.conf
    insertafter: EOF
    line: "PHPIniDir {{ phpinfo_path.stdout }}/php.ini"

- name: Stop httpd
  shell: apachectl stop
  environment:
    PATH: "/opt/httpd/bin:{{ ansible_env.PATH }}"

- name: Start httpd
  shell: apachectl start
  environment:
    PATH: "/opt/httpd/bin:{{ ansible_env.PATH }}"

- name: wp core install
  shell: >-
    wp core install --url=192.168.177.177/wordpress
    --path=/opt/httpd/htdocs/wordpress
    --title=vultest
    --admin_user={{ admin_user }}
    --admin_password="{{ admin_password }}"
    --admin_email=m5231118@u-aizu.ac.jp --allow-root
  environment:
    PATH: "/usr/local/bin:{{ ansible_env.PATH }}"
